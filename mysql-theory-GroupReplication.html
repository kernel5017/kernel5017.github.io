<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>mysql-theory-GroupReplication | 豪仔的老爹</title><meta name="author" content="豪仔的老爹"><meta name="copyright" content="豪仔的老爹"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="​    Groups能以自动选取primary模式，即single-primary模式运行，这个模式同一时间只有一个server接收updates。也能以multi-primary模式运行，这个模式中所有servers都能接收updates。 ​    对于给定时间点的所有servers来说，内置的组成员关系服务都能保证组视图的一致性和可用性。view会根据servers的leave或者join">
<meta property="og:type" content="article">
<meta property="og:title" content="mysql-theory-GroupReplication">
<meta property="og:url" content="https://www.for-dba.com/mysql-theory-GroupReplication.html">
<meta property="og:site_name" content="豪仔的老爹">
<meta property="og:description" content="​    Groups能以自动选取primary模式，即single-primary模式运行，这个模式同一时间只有一个server接收updates。也能以multi-primary模式运行，这个模式中所有servers都能接收updates。 ​    对于给定时间点的所有servers来说，内置的组成员关系服务都能保证组视图的一致性和可用性。view会根据servers的leave或者join">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg">
<meta property="article:published_time" content="2020-12-28T06:56:42.000Z">
<meta property="article:modified_time" content="2020-12-28T07:24:46.542Z">
<meta property="article:author" content="豪仔的老爹">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://www.for-dba.com/mysql-theory-GroupReplication"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}

// https://stackoverflow.com/questions/16839698/jquery-getscript-alternative-in-native-javascript
const getScript = url => new Promise((resolve, reject) => {
  const script = document.createElement('script')
  script.src = url
  script.async = true
  script.onerror = reject
  script.onload = script.onreadystatechange = function() {
    const loadState = this.readyState
    if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
    script.onload = script.onreadystatechange = null
    resolve()
  }
  document.head.appendChild(script)
})</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2020-12-28 15:24:46'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><meta name="generator" content="Hexo 5.2.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="https://5017-1304333899.cos.ap-beijing.myqcloud.com/webwxgetmsgimg.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">37</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">15</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">8</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 数据库&amp;存储</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/mysql/index.html"><span> MySQL</span></a></li><li><a class="site-page" href="/categories/etcd/"><span> ETCD</span></a></li><li><a class="site-page" href="/categories/redis/"><span> Redis</span></a></li><li><a class="site-page" href="/ceph/index.html"><span> Ceph</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> Linux</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/linux/index.html"><span> Linux</span></a></li><li><a class="site-page" href="/shell/index.html"><span> Shell</span></a></li><li><a class="site-page" href="/categories/iptables/"><span> Iptables</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> Kubernetes</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/rke/"><span> rke</span></a></li><li><a class="site-page" href="/kubernetes/index.html"><span> kubernetes</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 监控</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/prometheus/index.html"><span> Prometheus</span></a></li><li><a class="site-page" href="/categories/grafana/"><span> Grafana</span></a></li><li><a class="site-page" href="/categories/alertmanager/"><span> AlertMnager</span></a></li><li><a class="site-page" href="/categories/zabbix/"><span> Zabbix</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> Hadoop</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/cloudera/index.html"><span> cloudera</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 开发</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/golang/index.html"><span> Golang</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">豪仔的老爹</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 数据库&amp;存储</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/mysql/index.html"><span> MySQL</span></a></li><li><a class="site-page" href="/categories/etcd/"><span> ETCD</span></a></li><li><a class="site-page" href="/categories/redis/"><span> Redis</span></a></li><li><a class="site-page" href="/ceph/index.html"><span> Ceph</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> Linux</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/linux/index.html"><span> Linux</span></a></li><li><a class="site-page" href="/shell/index.html"><span> Shell</span></a></li><li><a class="site-page" href="/categories/iptables/"><span> Iptables</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> Kubernetes</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/rke/"><span> rke</span></a></li><li><a class="site-page" href="/kubernetes/index.html"><span> kubernetes</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 监控</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/prometheus/index.html"><span> Prometheus</span></a></li><li><a class="site-page" href="/categories/grafana/"><span> Grafana</span></a></li><li><a class="site-page" href="/categories/alertmanager/"><span> AlertMnager</span></a></li><li><a class="site-page" href="/categories/zabbix/"><span> Zabbix</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> Hadoop</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/cloudera/index.html"><span> cloudera</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 开发</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/golang/index.html"><span> Golang</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">mysql-theory-GroupReplication</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2020-12-28T06:56:42.000Z" title="Created 2020-12-28 14:56:42">2020-12-28</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2020-12-28T07:24:46.542Z" title="Updated 2020-12-28 15:24:46">2020-12-28</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/mysql/">mysql</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>​    Groups能以自动选取primary模式，即single-primary模式运行，这个模式同一时间只有一个server接收updates。也能以multi-primary模式运行，这个模式中所有servers都能接收updates。</p>
<p>​    对于给定时间点的所有servers来说，内置的组成员关系服务都能保证组视图的一致性和可用性。view会根据servers的leave或者join进行更新。有时候servers可能意外的离开了groups,这时failure dection mechanism会检测到这一情况，并且会通知groups view发生了改变，这一切都是自动发生的。</p>
<h2 id="传统主从复制技术"><a href="#传统主从复制技术" class="headerlink" title="传统主从复制技术"></a>传统主从复制技术</h2><p>​    传统的主从复制技术为一主一从，或者一主多从的复制架构。master执行事务，写入二进制日志后异步将event发送到所有slave上进行重放。这是一个非共享的系统，所有服务器都有一个完整的数据副本。在异步复制环境中，master不管你有没有收到自己的event，也不管你收到后有没有执行，它只管自己，自己执行完毕后，就会返回给client一个信号。就如下图所示</p>
<p>​    </p>
<p><img src="C:\Users\ly\AppData\Roaming\Typora\typora-user-images\image-20201224155003919.png" alt="image-20201224155003919"></p>
<p>还有一个半同步复制(semisynchronous replication)，master在commit前会等待slave发送ack，这个ack的内容表明slave<code>已经收到</code>event,注意只是已经收到，但是执行没执行master不管。master收到至少一个slave发送的ack后，才会进行commit，然后回复client。这样就确保如果master故障，至少有一个slave的数据是与master同步的。过程如下图：</p>
<p><img src="C:\Users\ly\AppData\Roaming\Typora\typora-user-images\image-20201224155855579.png" alt="image-20201224155855579"></p>
<h2 id="Group-Replication"><a href="#Group-Replication" class="headerlink" title="Group Replication"></a>Group Replication</h2><p>​    在Group Replication中，有两种事务：RW transaction和RO transaction。所有的RW transaction都必须经过groups内成员的共同决定才能进行commit,也就是说commit操作不是由发起transaction的server单方面决定的，你虽然发起了，但是可能不会被提交。确切的说，当发起transaction的server准备commit这个transaction时，这个server会自动的广播write values(rows changed)和correspondent write set(被更新行的唯一标识符)。这样对于这个transaction来说就形成了一个global total order。也就是说所有servers都以相同的顺序收到了相同的transaction set。所以，最后所有的server都已相同的顺序执行了相同的更新操作。所以保证了groups之间所有servers的一致性。</p>
<p>​    然而，在不同servers上并发执行时候可能存在transaction冲突。通过这两个事务的write sets可以检测到这种冲突。如果不同的server并发执行的两个transaction更新的是同一行的数据，这就产生了冲突。上面说过，提价事务时会生成一个global total order，这个是不会重复的，所以这两个冲突的事务谁的global total order更小，谁就会被所有的的server commit;另一个transaction会被其他所有servers丢弃，然后产生这个transaction的server会对这个事务进行rollback。</p>
<p><img src="C:\Users\ly\AppData\Roaming\Typora\typora-user-images\image-20201224163739749.png" alt="image-20201224163739749"></p>
<p>最后说一下，Group Replication是一种shared-nothing的复制方案，每个server都有一个完整数据集的copy。这里注意，这个copy并不是通过谁复制来的，而是Groups内所有server执行统一的transaction达成一致的。</p>
<p>​    由于Group Replication是multi-master的，所以不存在传统MySQL复制那种故障转移。传统MySQL如果master发生故障，需要选举出来一个新的master来接替故障master。但是Group Replication中，所有的server都是master，发生故障后并不影响整个集群的正常运行。但是需要注意的事，对于发生故障的server来说，之前所有连接到这个server的client都必须被重定向或故障转移到其他server上。这个问题不是Group Replication能解决的，需要依赖外部组件比如load balancer,router或其他一些中间件来处理这个问题。</p>
<h2 id="Group-Replication-细节"><a href="#Group-Replication-细节" class="headerlink" title="Group Replication 细节"></a>Group Replication 细节</h2><h3 id="Failure-Detection"><a href="#Failure-Detection" class="headerlink" title="Failure Detection"></a>Failure Detection</h3><p>​    Group Replication提供了一种故障检测机制，能够发现并报告哪些服务器是silent，silent被认为是死亡的。从一个较高层次来看，failure detector是一个分布式的service,它提供了那些server可能已经dead(<code>怀疑</code>)。之后如果groups认为这个‘怀疑’确实是真的，那么groups就会认定这个server确实发生了故障。也就是说groups中剩余的其他成员会经过协调做出一个一致的决定，把这个故障的成员排除掉。</p>
<p>​    当servers没有音信的时候，就会触发这个<code>怀疑</code>。比如当server A在给定的时间周期内没有收到server B的messages时，会发生timeout并且会产生这个<code>怀疑</code>。</p>
<p>​    如果一个server从group中被隔离出去了，那么这个server会怀疑其他所有server都已经failed了。但是由于没有达到组内的安全协议(没有达到法定数量)，所以这个server的怀疑也是没有结果的。这里说一下法定人数的问题。比如有三个server，其中一个server  A fail了，那么其他两个server如果都认为这个server A fail了，那么就会将server A剔除；如果剩余两个服务器有一个认为server A faild，但是另一个服务器不认为server A fail，所以没有达成法定的数量2，所以这个剔除操作是不会执行的。上面说的groups中被隔离出去的server只有自己认为其他server全挂了，所以他这个认为并没有什么卵用。</p>
<h3 id="Group-Membership"><a href="#Group-Membership" class="headerlink" title="Group Membership"></a>Group Membership</h3><p>​    MySQL Group Replication依赖于grou membership service。这个服务是内置在插件中的。这个服务指导哪些servers是online的，并且使在group中的。这些online servers的组成的列表被称为<code>view</code>。所以在group中的每个servers都有一个一致性的<code>view</code>。这些servers通过<code>view</code>就能知道group中的online的主机。</p>
<p>​    我们知道，在group中如果一个server要commit 一个transaction,那么需要其他servers也agree。<code>view</code>也是同样的。因此，当group中的所有servers都agree这个new server成为group中的一员时，group自己就会重置配置将new server加入到group中，接着就会触发<code>view</code>的变更。同样，如果server主动或者非主动离开了group，那么也会触发<code>view</code> change这个动作。</p>
<p>​    但是要注意，如果一个组成员是主动脱离group。它首先会主动发起一个dynamic group reconfiguration。这个会触发一个过程，那就是除了这个要脱离group的server外，其他剩余的servers需要agree new view。然而，如果一个server不是主动脱离group（比如宕机或者网络或连接问题导致），那么<code>failure detection</code>机制就能意识到这个情况，然后就会发起一个group reconfiguration，这一次的重新配置是不包活failed member的。就像之前说的，这个agree需要group中的大多数都同意。如果group不能达到agreeement（比如因故障导致大部分servers都不在线了），那么系统就不能像之前那样进行配置的变更，为了防止脑裂就会阻塞在这一刻。也就意味着需要管理员介入修复。</p>
<h3 id="Fault-tolerance"><a href="#Fault-tolerance" class="headerlink" title="Fault-tolerance"></a>Fault-tolerance</h3><p>MySQL组复制建立在Paxos提供的分布式算法上，实现上服务器间的分布式协调。所以，group需要大多数servers处于活动状态才能达到quorum,这有这样才能做出决定。在不影响自身和整体集群功能的前提下，这直接影响到系统所能容忍的故障点数量。servers的数量n,能容忍f个故障点:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">n = 2 * f +1</span><br><span class="line"></span><br><span class="line">比如n=3,那么能容忍1个故障点</span><br><span class="line">   n=4,能容忍1个故障点</span><br><span class="line">   n=5,能容忍2个故障点.....</span><br></pre></td></tr></table></figure>

<p>也就是说，如果想要能容忍有一个点发生故障，那么至少需要3个servers。这样，当一个点发生故障后，其他两个server还是属于<code>majority</code>（三分之二）所以能允许系统做出改变配置的决定。然后如果此时另一台server由于非主动原因发生故障了，此时group就会被阻塞(3台server只剩1台)，因为没法做出决定。</p>
<p><img src="C:\Users\ly\AppData\Roaming\Typora\typora-user-images\image-20201228110141619.png" alt="image-20201228110141619"></p>
<h2 id="配置Group-Replication"><a href="#配置Group-Replication" class="headerlink" title="配置Group Replication"></a>配置Group Replication</h2><p>  Group Replication是通过mysql server提供的一个plugin来使用的。在group中的每个server都必须配置并且安装了这个plugin。MySQL5.7.17及以后的版本都提供了Group Replication的默认插件。下面创建一个最小的(3节点)MySQL Group Replication。</p>
<h3 id="以single-mode部署Group-Replication"><a href="#以single-mode部署Group-Replication" class="headerlink" title="以single-mode部署Group Replication"></a>以single-mode部署Group Replication</h3><h5 id="准备三台MySQL-server"><a href="#准备三台MySQL-server" class="headerlink" title="准备三台MySQL server"></a>准备三台MySQL server</h5><p>过程略，自己装三个mysql server就好</p>
<h5 id="Group-Replication-需要的-一般配置"><a href="#Group-Replication-需要的-一般配置" class="headerlink" title="Group Replication 需要的 一般配置"></a>Group Replication 需要的 一般配置</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">server_id=1</span><br><span class="line">log_bin=binlog</span><br><span class="line">gtid_mode=ON</span><br><span class="line">enforce_gtid_consistency=ON</span><br><span class="line">master_info_repository=TABLE</span><br><span class="line">relay_log_info_repository=TABLE</span><br><span class="line">binlog_checksum=NONE</span><br><span class="line">log_slave_updates=ON</span><br><span class="line">binlog_format=ROW</span><br></pre></td></tr></table></figure>

<h5 id="Group-Replication-配置"><a href="#Group-Replication-配置" class="headerlink" title="Group Replication 配置"></a>Group Replication 配置</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">transaction_write_set_extraction=XXHASH64</span><br><span class="line">loose-group_replication_group_name=&quot;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa&quot;</span><br><span class="line">loose-group_replication_start_on_boot=off</span><br><span class="line">loose-group_replication_local_address= &quot;127.0.0.1:24901&quot;</span><br><span class="line">loose-group_replication_group_seeds= &quot;127.0.0.1:24901,127.0.0.1:24902,127.0.0.1:24903&quot;</span><br><span class="line">loose-group_replication_bootstrap_group= off</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：<strong>插件相关的参数</strong>只能在插件加载之后设置，如果想启动时设置这些参数并且启动后加载插件到配置文件中，可以在参数前加上“loose-”前缀。</p>
</blockquote>
<ul>
<li><strong>transaction_write_set_extraction</strong>:对于每个transaction,server都应该收集write set，并且使用XXHASH64 hash算法将它进行编码</li>
<li><strong>group_replication_group_name</strong>:告诉plugin,它加入的group或创建的group名字为这个</li>
<li><strong>group_replication_start_on_boot</strong>:告诉plugin不要在server启动后自动开始</li>
<li><strong>group_replication_local_address</strong>:告诉plugin,从group其他member连接到本机使用的是哪个IP和port</li>
<li><strong>group_replication_group_seeds</strong>:告诉plugin,在需要加入group时候，需要联系这些指定的host和port。这些为seed members,当有server想要加入到group中时候，就需要连接这些seed member。在加入到group之前，server首先需要联系其中一个seed member，然后这个seed member会要求group进行reconfigure来允许这个新member的加入。需要注意的是，这个选项并不是需要列出所有的group member,比如你有5个member，不用全部给出到这里。这里列出的只是server想要加入group的需要联系的servers是谁。</li>
</ul>
<p>​       start group的这个server是不会使用这个选项的，因为他是初始化server，他没得联系，只有他自己，它负责 引导这个group进行启动。第二个加入group的server会联系唯一的一个（引导group启动的那个server）server，然后加入集群;第三个加入group中的server可以联系<code>第一</code>或者<code>第二</code>个加入group中的任意一个。加下来任何加入group的server都是这个流程。</p>
<p>​        警告：</p>
<p>​                当同一时间向group中加入多个member时，要确保这些member指向的seed member已经都在group中了。不要将加入group中的member同时作为seed member，因为这些member被作为seed member被连接时，可能他还没有在group中呢。比如同时加入5个member A B C D E,但是你指定了seed member为E,但是A在加入到group中时连接E，此时E可能还没有在group中，就这个意思。</p>
<p>​                It is good practice to start the bootstrap member first, and let it create the group.Then make it the seed member for the rest of the members that are joining. This ensures that there is a group formed when joining the rest of the members</p>
<p>​        Creating a group and joining multiple members at the same time is not supported.It may work, but chances are that the operations race and then the act of joining the group ends up in an error or a time out.</p>
<ul>
<li><p><strong>group_replication_bootstrap_group</strong>:告诉plugin是否引导group</p>
<p>注意：这个选线在任何时候只能是在一个server上被使用，通常是引导group的server上。如果你引导group很多次，比如你在多台server上都配置了此选项，那么它们将会创建出一个人工脑裂的场景—两个不同的groups使用相同的name同时存在。再第一个server online以后，关闭这个选项。</p>
</li>
</ul>
<p>未完待续。。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">豪仔的老爹</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://www.for-dba.com/mysql-theory-GroupReplication.html">https://www.for-dba.com/mysql-theory-GroupReplication.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/hadoop-install.html"><img class="prev-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">hadoop-install</div></div></a></div><div class="next-post pull-right"><a href="/mysql-theory-createTableOutsideDatadir.html"><img class="next-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">mysql-theory-createTableOutsideDatadir</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside_content" id="aside_content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><img class="avatar-img" src="https://5017-1304333899.cos.ap-beijing.myqcloud.com/webwxgetmsgimg.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">豪仔的老爹</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">37</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">15</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">8</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div></div><div class="card-widget card-announcement"><div class="card-content"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>Announcement</span></div><div class="announcement_content">邮件交流：365084797@qq.com</div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%A0%E7%BB%9F%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E6%8A%80%E6%9C%AF"><span class="toc-number">1.</span> <span class="toc-text">传统主从复制技术</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Group-Replication"><span class="toc-number">2.</span> <span class="toc-text">Group Replication</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Group-Replication-%E7%BB%86%E8%8A%82"><span class="toc-number">3.</span> <span class="toc-text">Group Replication 细节</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Failure-Detection"><span class="toc-number">3.1.</span> <span class="toc-text">Failure Detection</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Group-Membership"><span class="toc-number">3.2.</span> <span class="toc-text">Group Membership</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Fault-tolerance"><span class="toc-number">3.3.</span> <span class="toc-text">Fault-tolerance</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEGroup-Replication"><span class="toc-number">4.</span> <span class="toc-text">配置Group Replication</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A5single-mode%E9%83%A8%E7%BD%B2Group-Replication"><span class="toc-number">4.1.</span> <span class="toc-text">以single-mode部署Group Replication</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E4%B8%89%E5%8F%B0MySQL-server"><span class="toc-number">4.1.0.1.</span> <span class="toc-text">准备三台MySQL server</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Group-Replication-%E9%9C%80%E8%A6%81%E7%9A%84-%E4%B8%80%E8%88%AC%E9%85%8D%E7%BD%AE"><span class="toc-number">4.1.0.2.</span> <span class="toc-text">Group Replication 需要的 一般配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Group-Replication-%E9%85%8D%E7%BD%AE"><span class="toc-number">4.1.0.3.</span> <span class="toc-text">Group Replication 配置</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/hadoop-install.html" title="hadoop-install">hadoop-install</a><time datetime="2020-12-30T02:46:47.000Z" title="Created 2020-12-30 10:46:47">2020-12-30</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/mysql-theory-GroupReplication.html" title="mysql-theory-GroupReplication">mysql-theory-GroupReplication</a><time datetime="2020-12-28T06:56:42.000Z" title="Created 2020-12-28 14:56:42">2020-12-28</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/mysql-theory-createTableOutsideDatadir.html" title="mysql-theory-createTableOutsideDatadir">mysql-theory-createTableOutsideDatadir</a><time datetime="2020-12-24T06:52:39.000Z" title="Created 2020-12-24 14:52:39">2020-12-24</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/mysql-theory-caseSensitivity.html" title="mysql-theory-caseSensitivity">mysql-theory-caseSensitivity</a><time datetime="2020-12-23T10:17:42.000Z" title="Created 2020-12-23 18:17:42">2020-12-23</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/mysql-theory-sqlMode.html" title="No title">No title</a><time datetime="2020-12-22T09:07:56.873Z" title="Created 2020-12-22 17:07:56">2020-12-22</time></div></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg)"><div id="footer-wrap"><div class="copyright">&copy;2020 By 豪仔的老爹</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    let initData = {
      el: '#vcomment',
      appId: '8pmThnDCYUdGoOgLWsVPzKOI-gzGzoHsz',
      appKey: 'nt3vchWbGYf7q7Txb7PjAu1B',
      placeholder: 'Please leave your footprints',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'en',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
    }

    if (true) { 
      initData.requiredFields= ('nick,mail'.split(','))
    }
    
    if (false) {
      const otherData = false
      initData = Object.assign({}, initData, otherData)
    }
    
    const valine = new Valine(initData)
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.querySelector('#vcomment'),loadValine)
  else setTimeout(() => loadValine(), 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-heart.min.js" async="async" mobile="false"></script></div></body></html>